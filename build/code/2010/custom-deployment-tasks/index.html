<!doctype html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8">
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Tâches de déploiement spécifiques avec Symfony | Code | Nicolas Perriault</title>
    <meta name="description" content="Nicolas Perriault's homepage.">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" type="text/css" href="/static/packed.css?1331656984">
    <link rel="alternate" type="application/rss+xml" href="/code/feed/" title="Code (RSS)">
    <link rel="alternate" type="application/rss+xml" href="/photography/feed/" title="Photography (RSS)">
    <link rel="alternate" type="application/rss+xml" href="/talks/feed/" title="Talks (RSS)">
    <link rel="alternate" type="application/rss+xml" href="/carnet/feed/" title="Carnet (RSS)">
    <link rel="alternate" type="application/rss+xml" href="/feed/" title="Everything (RSS)">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body class="code ">
    <!--[if lt IE 7]>
    <p class="chromeframe">Your browser is <em>ancient!</em> Please <a href="http://www.quirksmode.org/upgrade.html">upgrade</a>.</p>
    <![endif]-->
    <div class="container">
        <header class="main-title">
            <h1><a href="/">Hi, I'm <strong>Nicolas.</strong></a></h1>
            <small>I code stuff. I take photos. I write rants.</small>
        </header>
        <div class="contents">
            

    <article lang="fr" class="code" itemscope itemtype="http://schema.org/BlogPosting">
    <link itemprop="url" href="/code/2010/custom-deployment-tasks/">
    <header>
        <h2><a itemprop="name" href="/code/2010/custom-deployment-tasks/">Tâches de déploiement spécifiques avec Symfony</a></h2></header>
    
    <section>
        <p><a href="http://www.symfony-project.org/">Symfony</a> propose une tâche de déploiement distant utilisant <a href="http://fr.wikipedia.org/wiki/Rsync"><code>rsync</code></a> fort pratique&nbsp;: une fois configurés les <a href="http://www.symfony-project.org/jobeet/1_4/Doctrine/en/22#chapter_22_deploying">paramètres du serveur distant</a> dans le fichier <code>config/properties.ini</code> de votre projet, un simple appel en ligne de commande synchronisera les fichiers du projet présents sur votre système de fichiers local vers l'hôte distant. Et si vous utilisez une <a href="http://prendreuncafe.com/blog/post/2005/08/29/262-installer-sa-cle-ssh-sur-un-serveur-distant">clé SSH</a>, l'opération ne vous demandera même pas de saisir votre mot de passe&nbsp;!</p>
<div class="codehilite"><pre>$ <span class="o">./</span><span class="n">symfony</span> <span class="n">project</span><span class="p">:</span><span class="n">deploy</span> <span class="n">monserveur</span> <span class="o">--</span><span class="n">go</span>
</pre></div>


<p>Mais bien souvent, nous avons besoin de plus&nbsp;: préparer un certain nombre de fichiers statiques comme les assets CSS, JavaScript ou les images, ou vider le cache sur la ou les machines distantes pour prendre en compte d'éventuelles modifications de la configuration ou du templating sur la plateforme de production (qui exploite l'environnement du même nom, nous sommes bien d'accord).</p>
<p>Aussi, il est très simple de faire face à ces besoins spécifiques en créant vous même une tâche de déploiement projet, en surclassant la classe <code>sfProjectDeployTask</code> fournie en standard par Symfony. Par exemple, voici la tâche de déploiement que j'utilise pour la mise à jour du site <a href="http://www.akei.com/">Akei</a>, exploitant mon plugin <a href="http://github.com/n1k0/npAssetsOptimizerPlugin"><code>npAssetsOptimizerPlugin</code></a> pour la gestion de la minification et l'assemblage des fichiers JavaScript, CSS et images PNG &nbsp;:</p>
<div class="codehilite"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">AkeiDeployTask</span> <span class="k">extends</span> <span class="nx">sfProjectDeployTask</span>
<span class="p">{</span>
  <span class="sd">/**</span>
<span class="sd">   * @see sfProjectDeployTask</span>
<span class="sd">   */</span>
  <span class="k">protected</span> <span class="k">function</span> <span class="nf">configure</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addArguments</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
      <span class="k">new</span> <span class="nx">sfCommandArgument</span><span class="p">(</span><span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="nx">sfCommandArgument</span><span class="o">::</span><span class="na">REQUIRED</span><span class="p">,</span> <span class="s1">&#39;The server name&#39;</span><span class="p">),</span>
    <span class="p">));</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addOptions</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
      <span class="k">new</span> <span class="nx">sfCommandOption</span><span class="p">(</span><span class="s1">&#39;go&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nx">sfCommandOption</span><span class="o">::</span><span class="na">PARAMETER_NONE</span><span class="p">,</span> <span class="s1">&#39;Do the deployment&#39;</span><span class="p">),</span>
      <span class="k">new</span> <span class="nx">sfCommandOption</span><span class="p">(</span><span class="s1">&#39;rsync-dir&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nx">sfCommandOption</span><span class="o">::</span><span class="na">PARAMETER_REQUIRED</span><span class="p">,</span> <span class="s1">&#39;The directory where to look for rsync*.txt files&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">),</span>
      <span class="k">new</span> <span class="nx">sfCommandOption</span><span class="p">(</span><span class="s1">&#39;rsync-options&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nx">sfCommandOption</span><span class="o">::</span><span class="na">PARAMETER_OPTIONAL</span><span class="p">,</span> <span class="s1">&#39;To options to pass to the rsync executable&#39;</span><span class="p">,</span> <span class="s1">&#39;-azC --force --delete --progress&#39;</span><span class="p">),</span>
      <span class="k">new</span> <span class="nx">sfCommandOption</span><span class="p">(</span><span class="s1">&#39;optimize&#39;</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nx">sfCommandOption</span><span class="o">::</span><span class="na">PARAMETER_OPTIONAL</span><span class="p">,</span> <span class="s1">&#39;The asset optimizations to make before deploying&#39;</span><span class="p">),</span>
    <span class="p">));</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">namespace</span> <span class="o">=</span> <span class="s1">&#39;akei&#39;</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="s1">&#39;deploy&#39;</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">briefDescription</span> <span class="o">=</span> <span class="s1">&#39;Deploys Akei website to a given server&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="sd">/**</span>
<span class="sd">   * @see sfProjectDeployTask</span>
<span class="sd">   */</span>
  <span class="k">protected</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(</span><span class="nv">$arguments</span> <span class="o">=</span> <span class="k">array</span><span class="p">(),</span> <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="c1">// Assets</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">is_null</span><span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;optimize&#39;</span><span class="p">]))</span>
    <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logSection</span><span class="p">(</span><span class="s1">&#39;deploy&#39;</span><span class="p">,</span> <span class="s1">&#39;assets optimization before deploying&#39;</span><span class="p">);</span>
      <span class="nv">$task</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">npOptimizeAssetsTask</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dispatcher</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">formatter</span><span class="p">);</span>
      <span class="nv">$task</span><span class="o">-&gt;</span><span class="na">run</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;application&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;main&#39;</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;optimize&#39;</span><span class="p">]));</span>
    <span class="p">}</span>

    <span class="c1">// Deployment</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logSection</span><span class="p">(</span><span class="s1">&#39;deploy&#39;</span><span class="p">,</span> <span class="s1">&#39;deploying...&#39;</span><span class="p">);</span>
    <span class="k">parent</span><span class="o">::</span><span class="na">execute</span><span class="p">(</span><span class="nv">$arguments</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>

    <span class="c1">// Remote symfony cc</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$options</span><span class="p">[</span><span class="s1">&#39;go&#39;</span><span class="p">])</span>
    <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logSection</span><span class="p">(</span><span class="s1">&#39;deploy&#39;</span><span class="p">,</span> <span class="s1">&#39;remote cache clear&#39;</span><span class="p">);</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getFilesystem</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="s1">&#39;ssh user@monserveur.foo &quot;/path/to/www/akei/symfony cache:clear&quot;&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logSection</span><span class="p">(</span><span class="s1">&#39;deploy&#39;</span><span class="p">,</span> <span class="s1">&#39;done.&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Comme vous pouvez le constater, cette tâche déclare un espace de nom <code>akei</code> et propose une option supplémentaire, <code>optimize</code>, permettant de préparer les assets avant déploiement&nbsp;:</p>
<div class="codehilite"><pre>$ <span class="o">./</span><span class="n">symfony</span> <span class="n">akei</span><span class="p">:</span><span class="n">deploy</span> <span class="n">monserveur</span> <span class="o">--</span><span class="n">optimize</span><span class="p">=</span><span class="n">stylesheet</span> <span class="o">--</span><span class="n">go</span>
</pre></div>


<p>Cette commande va tout simplement minifier et assembler les feuilles de style définies par la configuration du plugin <code>npAssetsOptimizerPlugin</code>, déployer les fichiers en production sur la machine <code>monserveur</code> et vider le cache sur la machine distante une fois l'opération effectuée.</p>
<p>Notez d'ailleurs l'emploi du très pratique appel à <code>$this-&gt;getFilesystem()-&gt;execute()</code>, qui permet d'executer des appels à la ligne de commande locale depuis la classe de tâche elle-même&nbsp;; ici, une execution distante à travers SSH.</p>
<p>Bien entendu, cet exemple est très spécifique aux besoins du site Akei, mais vous pourriez en quelques minutes gérer plus finement une tâche de déploiement plus générique et configurable. Pensez-y pour vos projets ;)</p>
<p>PS&nbsp;: Ce billet a été écrit en 14 minutes. Merci de votre compréhension.</p>
    </section>
    <aside>
        <p>
            <span class="article-author" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <span itemprop="name">Nicolas Perriault</span> —
            </span>
            <time datetime="2010-05-25" itemprop="datePublished">2010-05-25</time>
            — in <a href="/code/" itemprop="genre">Code</a>
            — <a href="/code/2010/custom-deployment-tasks/">Permalink</a>
            — <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">License</a>.
        </p>
    </aside>
    <hr>
    <nav>
        <a class="prev" href="/code/2010/express/">A First Look at node.js and Express</a>
        |
        <a class="next" href="/code/2010/django-with-pip-virtualenv/">Installer Django dans un environnement Python virtuel avec pip, virtualenv et virtualenvwrapper</a>
    </nav>
</article>


        </div>
        <nav class="sidebar">
            <ul>
                <li class="home"><a href="/" hreflang="en">Home</a></li>
                <li class="code"><a href="/code/" hreflang="en">Code</a></li>
                <li class="photography"><a href="/photography/" hreflang="en">Photography</a></li>
                <li class="talks"><a href="/talks/" hreflang="en">Talks</a></li>
                <li class="carnet"><a href="/carnet/" hreflang="fr">Carnet <span>fr</span></a></li>
                <li class="contact"><a href="/contact/" hreflang="en">Contact</a></li>
            </ul>
        </nav>
        <footer class="site-footer">
            <p>
                &copy; 2012 Nicolas Perriault
                — <a href="https://twitter.com/n1k0">Tweet at me</a>
                — <a href="https://github.com/n1k0">Get my code</a>
                — <a href="http://500px.com/n1k0">Enjoy my pics</a>
                — <a href="/contact/">Contact me</a>
            </p>
        </footer>
    </div>
    <!-- /container -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/libs/jquery-1.7.1.min.js"><\/script>')</script>
    <script type="text/javascript" src="/static/packed.js?1331026602"></script>
    <script src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
</body>
</html>