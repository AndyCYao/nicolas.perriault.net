<!doctype html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8">
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Hosting a Symfony app on NginX using PHP-FPM | Code | Nicolas Perriault</title>
    <meta name="description" content="Nicolas Perriault's homepage.">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" type="text/css" href="/static/packed.css?1331656984">
    <link rel="alternate" type="application/rss+xml" href="/code/feed/" title="Code (RSS)">
    <link rel="alternate" type="application/rss+xml" href="/photography/feed/" title="Photography (RSS)">
    <link rel="alternate" type="application/rss+xml" href="/talks/feed/" title="Talks (RSS)">
    <link rel="alternate" type="application/rss+xml" href="/carnet/feed/" title="Carnet (RSS)">
    <link rel="alternate" type="application/rss+xml" href="/feed/" title="Everything (RSS)">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body class="code ">
    <!--[if lt IE 7]>
    <p class="chromeframe">Your browser is <em>ancient!</em> Please <a href="http://www.quirksmode.org/upgrade.html">upgrade</a>.</p>
    <![endif]-->
    <div class="container">
        <header class="main-title">
            <h1><a href="/">Hi, I'm <strong>Nicolas.</strong></a></h1>
            <small>I code stuff. I take photos. I write rants.</small>
        </header>
        <div class="contents">
            

    <article lang="en" class="code" itemscope itemtype="http://schema.org/BlogPosting">
    <link itemprop="url" href="/code/2010/symfony-nginx-php-fpm/">
    <header>
        <h2><a itemprop="name" href="/code/2010/symfony-nginx-php-fpm/">Hosting a Symfony app on NginX using PHP-FPM</a></h2></header>
    
    <section>
        <p>I recently had to make a capacity planning study for a client of mine for which I've been developing a Symfony application. Despite the hardware/cloud architecture problem, I also tried to optimize application performances from a webserver software point of view (the application is currently hosted on a standard Apache2 server using mod_php5). I dug Google a bit and found some very enthusiastic comments on <a href="http://php-fpm.org/">PHP-FPM</a>, a PHP <a href="http://www.fastcgi.com/">FastCGI</a> implementation and the <a href="http://nginx.org/">NginX</a> web server.</p>
<p>While PHP-FPM has just <a href="http://www.php.net/manual/fr/install.fpm.php">made it to PHP core</a> in version 5.3.3, the OS version of the linux server we are using, Ubuntu 10.04 LTS, only ships with 5.3.2. Fortunately, <a href="https://launchpad.net/~brianmercer/+archive/php">Brian Mercer released a PHP-FPM sapi</a> for these particular OS and PHP versions.</p>
<p>So installing PHP and PHP-FPM on Ubuntu Lucid Lynx is as easy as:</p>
<div class="codehilite"><pre>$ <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">software</span><span class="o">-</span><span class="k">properties</span>
$ <span class="n">sudo</span> <span class="n">add</span><span class="o">-</span><span class="n">apt</span><span class="o">-</span><span class="n">repository</span> <span class="n">ppa</span><span class="p">:</span><span class="n">brianmercer</span><span class="o">/</span><span class="n">php</span>
$ <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
$ <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">php5</span><span class="o">-</span><span class="n">cli</span> <span class="n">php5</span><span class="o">-</span><span class="n">common</span> <span class="n">php5</span><span class="o">-</span><span class="n">mysql</span> <span class="n">php5</span><span class="o">-</span><span class="n">suhosin</span> <span class="o">\</span>
    <span class="n">php5</span><span class="o">-</span><span class="n">gd</span> <span class="n">php5</span><span class="o">-</span><span class="n">fpm</span> <span class="n">php5</span><span class="o">-</span><span class="n">cgi</span> <span class="n">php</span><span class="o">-</span><span class="n">pear</span> <span class="n">php5</span><span class="o">-</span><span class="n">memcache</span> <span class="n">php</span><span class="o">-</span><span class="n">apc</span>
</pre></div>


<p>Of course, feel free to add any supplementary packages you need. To start up the PHP-FPM service, run:</p>
<div class="codehilite"><pre>$ <span class="n">sudo</span> <span class="n">service</span> <span class="n">php5</span><span class="o">-</span><span class="n">fpm</span> <span class="n">start</span>
</pre></div>


<p>As a side note, the service will run on port 9000 by default, but you can tweak this up by editing its configuration file located at <code>/etc/php5/fpm/php-fpm.conf</code>.</p>
<p>Now, let's install the NginX web server:</p>
<div class="codehilite"><pre>$ <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">nginx</span>
</pre></div>


<p>That's it. Let's create a new site configuration for our Symfony application in a new <code>/etc/nginx/sites-available/mywonderfulwebsite.org</code> file:</p>
<div class="codehilite"><pre><span class="n">server</span> <span class="p">{</span>
    <span class="n">set</span> $<span class="n">website_host</span> &quot;<span class="n">mywonderfulwebsite</span><span class="p">.</span><span class="n">org</span>&quot;<span class="p">;</span>
    <span class="n">set</span> $<span class="n">website_root</span> &quot;<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">mywonderfulwebsite</span><span class="o">/</span><span class="n">web</span>&quot;<span class="p">;</span>
    <span class="n">set</span> $<span class="n">default_controller</span> &quot;<span class="n">index</span><span class="p">.</span><span class="n">php</span>&quot;<span class="p">;</span>
    <span class="n">set</span> $<span class="n">symfony_root</span> &quot;<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">mywonderfulwebsite</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">symfony</span>&quot;<span class="p">;</span>

    <span class="n">listen</span> 80<span class="p">;</span>
    <span class="n">server_name</span> $<span class="n">website_host</span><span class="p">;</span>

    # <span class="n">Gzip</span>
    <span class="n">gzip</span> <span class="n">on</span><span class="p">;</span>
    <span class="n">gzip_min_length</span> 1000<span class="p">;</span>
    <span class="n">gzip_types</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span> <span class="n">text</span><span class="o">/</span><span class="n">css</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">javascript</span> <span class="n">text</span><span class="o">/</span><span class="n">xml</span> <span class="n">application</span><span class="o">/</span><span class="n">xml</span> <span class="n">application</span><span class="o">/</span><span class="n">xml</span><span class="o">+</span><span class="n">rss</span> <span class="n">text</span><span class="o">/</span><span class="n">javascript</span><span class="p">;</span>
    <span class="n">gzip_disable</span> &quot;<span class="n">MSIE</span> <span class="p">[</span>1<span class="o">-</span>6<span class="p">]</span><span class="o">\</span><span class="p">.</span>&quot;<span class="p">;</span>

    <span class="n">access_log</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="nb">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span>$<span class="n">website_host</span><span class="p">.</span><span class="n">access</span><span class="p">.</span><span class="nb">log</span><span class="p">;</span>

    <span class="n">root</span> $<span class="n">website_root</span><span class="p">;</span>

    <span class="n">index</span> $<span class="n">default_controller</span><span class="p">;</span>

    <span class="n">charset</span> <span class="n">utf</span><span class="o">-</span>8<span class="p">;</span>

    <span class="n">location</span> <span class="o">/</span><span class="n">sf</span> <span class="p">{</span>
        # <span class="n">path</span> <span class="n">to</span> <span class="n">folder</span> <span class="n">where</span> <span class="n">all</span> <span class="n">symfony</span> <span class="n">assets</span> <span class="n">are</span> <span class="n">located</span>
        <span class="n">alias</span> $<span class="n">symfony_root</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">web</span><span class="o">/</span><span class="n">sf</span><span class="p">;</span>
        <span class="n">expires</span> <span class="n">max</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
        # <span class="n">If</span> <span class="n">the</span> <span class="n">file</span> <span class="n">exists</span> <span class="n">as</span> <span class="n">a</span> <span class="n">static</span> <span class="n">file</span> <span class="n">serve</span> <span class="n">it</span> <span class="n">directly</span> <span class="n">without</span>
        # <span class="n">running</span> <span class="n">all</span> <span class="n">the</span> <span class="n">other</span> <span class="n">rewite</span> <span class="n">tests</span> <span class="n">on</span> <span class="n">it</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">f</span> $<span class="n">request_filename</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">expires</span> <span class="n">max</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span>$<span class="n">request_filename</span> !<span class="o">~</span> &quot;<span class="o">\</span><span class="p">.(</span><span class="n">js</span><span class="o">|</span><span class="n">htc</span><span class="o">|</span><span class="n">ico</span><span class="o">|</span><span class="n">gif</span><span class="o">|</span><span class="n">jpg</span><span class="o">|</span><span class="n">png</span><span class="o">|</span><span class="n">css</span><span class="p">)</span>$&quot;<span class="p">)</span> <span class="p">{</span>
            <span class="n">rewrite</span> ^<span class="p">(</span><span class="o">.*</span><span class="p">)</span> <span class="o">/</span>$<span class="n">default_controller</span>$1 <span class="n">last</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">location</span> <span class="o">~</span> &quot;^<span class="p">(.</span><span class="o">+\</span><span class="p">.</span><span class="n">php</span><span class="p">)(</span>$<span class="o">|/</span><span class="p">)</span>&quot; <span class="p">{</span>

        <span class="n">set</span> $<span class="n">script</span> $<span class="n">uri</span><span class="p">;</span>
        <span class="n">set</span> $<span class="n">path_info</span> &quot;<span class="o">/</span>&quot;<span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span>$<span class="n">uri</span> <span class="o">~</span> &quot;^<span class="p">(.</span><span class="o">+\</span><span class="p">.</span><span class="n">php</span><span class="p">)(</span>$<span class="o">|/</span><span class="p">)</span>&quot;<span class="p">)</span> <span class="p">{</span>
            <span class="n">set</span> $<span class="n">script</span> $1<span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span>$<span class="n">uri</span> <span class="o">~</span> &quot;^<span class="p">(.</span><span class="o">+\</span><span class="p">.</span><span class="n">php</span><span class="p">)(</span><span class="o">/</span><span class="p">.</span><span class="o">+</span><span class="p">)</span>&quot;<span class="p">)</span> <span class="p">{</span>
            <span class="n">set</span> $<span class="n">script</span> $1<span class="p">;</span>
            <span class="n">set</span> $<span class="n">path_info</span> $2<span class="p">;</span>
        <span class="p">}</span>

        <span class="n">include</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">fastcgi_params</span><span class="p">;</span>
        <span class="n">fastcgi_pass</span> 127<span class="p">.</span>0<span class="p">.</span>0<span class="p">.</span>1<span class="p">:</span>9000<span class="p">;</span>

        <span class="n">fastcgi_param</span> <span class="n">SCRIPT_FILENAME</span> $<span class="n">website_root</span>$<span class="n">script</span><span class="p">;</span>
        <span class="n">fastcgi_param</span> <span class="n">SCRIPT_NAME</span> $<span class="n">script</span><span class="p">;</span>
        <span class="n">fastcgi_param</span> <span class="n">PATH_INFO</span> $<span class="n">path_info</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>As you may have noticed, I'm taking part of the convenient custom variable system of the NginX configuration syntax, so you'll probably just have to adapt the <code>$website_host</code>, <code>$website_root</code>, <code>$default_controller</code> and <code>$symfony_root</code> variables to your project needs.</p>
<p>Enabling the website is achieved with a symbolic link, like this:</p>
<div class="codehilite"><pre>$ <span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">sf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">available</span><span class="o">/</span><span class="n">mywonderfulwebsite</span><span class="p">.</span><span class="n">org</span> <span class="o">\</span>
              <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sites</span><span class="o">-</span><span class="n">enabled</span><span class="o">/</span><span class="n">mywonderfulwebsite</span><span class="p">.</span><span class="n">org</span>
</pre></div>


<p>Last but not least, don't forget to launch the webserver:</p>
<div class="codehilite"><pre>$ <span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span> <span class="n">start</span>
</pre></div>


<p>I did some benchmarks but unfortunately the hardware configuration being quite different between the old and the new platform, the statistics generated did not make much sense. But the reactivity of the application, and memory footprint is much much better with the new setup (I know, this is not a very scientific statement).</p>
<h3>Sources</h3>
<ul>
<li><a href="http://constantshift.com/install-php-fpm-5-3-2-on-ubuntu-10-04-lucid-lynx/">Install PHP-FPM 5.3.2 on Ubuntu 10.04 (Lucid Lynx) | Constant Shift</a></li>
<li><a href="http://symfonynotes.com/2009/12/04/hosting-symfony-based-website-with-nginx/">Hosting symfony based website with nginx</a></li>
</ul>
    </section>
    <aside>
        <p>
            <span class="article-author" itemprop="author" itemscope itemtype="http://schema.org/Person">
                <span itemprop="name">Nicolas Perriault</span> —
            </span>
            <time datetime="2010-09-27" itemprop="datePublished">2010-09-27</time>
            — in <a href="/code/" itemprop="genre">Code</a>
            — <a href="/code/2010/symfony-nginx-php-fpm/">Permalink</a>
            — <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">License</a>.
        </p>
    </aside>
    <hr>
    <nav>
        <a class="prev" href="/code/2010/pil-install/">Install PIL within a virtualenv on Snow Leopard</a>
        |
        <a class="next" href="/code/2010/express/">A First Look at node.js and Express</a>
    </nav>
</article>


        </div>
        <nav class="sidebar">
            <ul>
                <li class="home"><a href="/" hreflang="en">Home</a></li>
                <li class="code"><a href="/code/" hreflang="en">Code</a></li>
                <li class="photography"><a href="/photography/" hreflang="en">Photography</a></li>
                <li class="talks"><a href="/talks/" hreflang="en">Talks</a></li>
                <li class="carnet"><a href="/carnet/" hreflang="fr">Carnet <span>fr</span></a></li>
                <li class="contact"><a href="/contact/" hreflang="en">Contact</a></li>
            </ul>
        </nav>
        <footer class="site-footer">
            <p>
                &copy; 2012 Nicolas Perriault
                — <a href="https://twitter.com/n1k0">Tweet at me</a>
                — <a href="https://github.com/n1k0">Get my code</a>
                — <a href="http://500px.com/n1k0">Enjoy my pics</a>
                — <a href="/contact/">Contact me</a>
            </p>
        </footer>
    </div>
    <!-- /container -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/libs/jquery-1.7.1.min.js"><\/script>')</script>
    <script type="text/javascript" src="/static/packed.js?1331026602"></script>
    <script src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
</body>
</html>